## Codebase Patterns
- FastAPI CSV export pattern: Use StreamingResponse with StringIO, csv.writer, and Content-Disposition header
- Authentication via CurrentUser dependency from app.core.deps
- Backend quality checks: `docker exec opm-backend uv run mypy src/` and `docker exec opm-backend uv run ruff check src/`
- Endpoint pattern: fetch model with relationships → return 404 if not found → process data → return response

---

## 2026-01-27 - US-001
- Implemented GET /api/scans/{scan_id}/export/csv endpoint
- Added CSV export functionality with proper headers (IP, Port, Protocol, Service, First Seen, Last Seen)
- Used FastAPI StreamingResponse with proper Content-Disposition header for file download
- Filename format: scan_{scan_id}_{timestamp}.csv

**Files changed:**
- backend/src/app/routers/scans.py

**Learnings for future iterations:**
- FastAPI pattern for CSV exports: Use StreamingResponse with StringIO and csv.writer
- Authentication is handled via CurrentUser dependency (from app.core.deps)
- Use datetime.now(timezone.utc).strftime() for timestamp formatting in filenames
- CSV data should use .isoformat() for datetime serialization
- Quality checks: Run `docker exec opm-backend uv run mypy src/` and `docker exec opm-backend uv run ruff check src/`
- The backend uses FastAPI with async SQLAlchemy, all endpoints should be async
- Service layer functions (in app/services/) handle database operations
- Endpoint pattern: get model with relationships, return 404 if not found, process data, return response
---

## 2026-01-27 - US-002
- Implemented GET /api/alerts/export/csv endpoint
- Added CSV export functionality with proper headers (Alert Type, IP, Port, Network, Status, Created At)
- Supports optional query params: alert_type (alias "type") and acknowledged for filtering
- Uses FastAPI StreamingResponse with proper Content-Disposition header for file download
- Filename format: alerts_{timestamp}.csv

**Files changed:**
- backend/src/app/routers/alerts.py

**Learnings for future iterations:**
- Alert model doesn't have an `acknowledged_at` field, only an `acknowledged` boolean
- The CSV export uses the same pattern as scans: csv.writer with StringIO
- Query parameter alias "type" is used for alert_type to match existing API patterns
- For exports, use a large limit (10000) instead of pagination to get all records
- The alerts_service.get_alerts() returns tuples of (alert, network_name) for each alert
---

## 2026-01-27 - US-003
- Implemented GET /api/hosts/export/csv endpoint
- Added CSV export functionality with proper headers (IP, Hostname, Status, OS Guess, First Seen, Last Seen, Open Ports Count)
- Supports optional query params: network_id and is_pingable (aliased as "status") for filtering
- Uses FastAPI StreamingResponse with proper Content-Disposition header for file download
- Filename format: hosts_{timestamp}.csv
- Status field derived from is_pingable: null = "Unknown", true = "Up", false = "Down"

**Files changed:**
- backend/src/app/routers/hosts.py

**Learnings for future iterations:**
- Host model doesn't have an OS guess field, so it's left empty in the CSV export
- The is_pingable field can be null, true, or false - need to handle all three cases
- For hosts export, need to fetch open port count for each host individually using hosts_service.get_open_port_count_for_host()
- The query parameter alias can be used to provide alternative names (e.g., "status" maps to is_pingable)
- Pre-existing mypy errors in hosts service are not related to new router code
---
