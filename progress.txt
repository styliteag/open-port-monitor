## Codebase Patterns
- FastAPI CSV export pattern: Use StreamingResponse with StringIO, csv.writer, and Content-Disposition header
- FastAPI PDF export pattern: Use StreamingResponse with BytesIO, ReportLab SimpleDocTemplate, and list[Flowable] for elements
- Authentication via CurrentUser dependency from app.core.deps
- Backend quality checks: `docker exec opm-backend uv run mypy src/` and `docker exec opm-backend uv run ruff check src/`
- Endpoint pattern: fetch model with relationships → return 404 if not found → process data → return response
- For reportlab: Install both reportlab package and types-reportlab for type stubs

---

## 2026-01-27 - US-001
- Implemented GET /api/scans/{scan_id}/export/csv endpoint
- Added CSV export functionality with proper headers (IP, Port, Protocol, Service, First Seen, Last Seen)
- Used FastAPI StreamingResponse with proper Content-Disposition header for file download
- Filename format: scan_{scan_id}_{timestamp}.csv

**Files changed:**
- backend/src/app/routers/scans.py

**Learnings for future iterations:**
- FastAPI pattern for CSV exports: Use StreamingResponse with StringIO and csv.writer
- Authentication is handled via CurrentUser dependency (from app.core.deps)
- Use datetime.now(timezone.utc).strftime() for timestamp formatting in filenames
- CSV data should use .isoformat() for datetime serialization
- Quality checks: Run `docker exec opm-backend uv run mypy src/` and `docker exec opm-backend uv run ruff check src/`
- The backend uses FastAPI with async SQLAlchemy, all endpoints should be async
- Service layer functions (in app/services/) handle database operations
- Endpoint pattern: get model with relationships, return 404 if not found, process data, return response
---

## 2026-01-27 - US-002
- Implemented GET /api/alerts/export/csv endpoint
- Added CSV export functionality with proper headers (Alert Type, IP, Port, Network, Status, Created At)
- Supports optional query params: alert_type (alias "type") and acknowledged for filtering
- Uses FastAPI StreamingResponse with proper Content-Disposition header for file download
- Filename format: alerts_{timestamp}.csv

**Files changed:**
- backend/src/app/routers/alerts.py

**Learnings for future iterations:**
- Alert model doesn't have an `acknowledged_at` field, only an `acknowledged` boolean
- The CSV export uses the same pattern as scans: csv.writer with StringIO
- Query parameter alias "type" is used for alert_type to match existing API patterns
- For exports, use a large limit (10000) instead of pagination to get all records
- The alerts_service.get_alerts() returns tuples of (alert, network_name) for each alert
---

## 2026-01-27 - US-003
- Implemented GET /api/hosts/export/csv endpoint
- Added CSV export functionality with proper headers (IP, Hostname, Status, OS Guess, First Seen, Last Seen, Open Ports Count)
- Supports optional query params: network_id and is_pingable (aliased as "status") for filtering
- Uses FastAPI StreamingResponse with proper Content-Disposition header for file download
- Filename format: hosts_{timestamp}.csv
- Status field derived from is_pingable: null = "Unknown", true = "Up", false = "Down"

**Files changed:**
- backend/src/app/routers/hosts.py

**Learnings for future iterations:**
- Host model doesn't have an OS guess field, so it's left empty in the CSV export
- The is_pingable field can be null, true, or false - need to handle all three cases
- For hosts export, need to fetch open port count for each host individually using hosts_service.get_open_port_count_for_host()
- The query parameter alias can be used to provide alternative names (e.g., "status" maps to is_pingable)
- Pre-existing mypy errors in hosts service are not related to new router code
---

## 2026-01-27 - US-004
- Implemented GET /api/scans/{scan_id}/export/pdf endpoint
- Installed reportlab library (version 4.4.9) for PDF generation
- PDF includes scan metadata (network name, scan date, status, completion date)
- PDF includes summary statistics showing total open ports found
- PDF includes detailed table of open ports with headers: IP, Port, Protocol, Service, First Seen, Last Seen
- Filename format: scan_{scan_id}_{timestamp}.pdf
- Used ReportLab's SimpleDocTemplate, Paragraph, Table, and TableStyle for PDF generation

**Files changed:**
- backend/src/app/routers/scans.py
- backend/pyproject.toml

**Learnings for future iterations:**
- FastAPI PDF export pattern: Use StreamingResponse with BytesIO (not StringIO like CSV)
- ReportLab requires type annotations: use `list[Flowable]` for elements list to pass mypy strict mode
- Install both `reportlab` package AND `types-reportlab` for type stubs to pass mypy checks
- ReportLab uses inch units from reportlab.lib.units for sizing
- Table styling uses TableStyle with tuples like ('BACKGROUND', (0, 0), (-1, 0), colors.grey)
- For long lines that exceed 100 chars (ruff E501), extract variables or use parentheses for multi-line expressions
- PDF generation uses same authentication pattern (CurrentUser) and error handling (404) as CSV exports
- The `doc.build(elements)` method writes to the BytesIO buffer, then get content with buffer.getvalue()
---
## 2026-01-27 - US-005
- Implemented GET /api/alerts/export/pdf endpoint
- PDF includes report header with generation timestamp
- PDF includes summary statistics: total alerts, open/acknowledged counts, breakdown by alert type
- PDF includes detailed table of alerts with columns: Alert Type, IP, Port, Network, Status, Created At
- Supports optional query params: alert_type (alias "type") and acknowledged for filtering
- Filename format: alerts_{timestamp}.pdf
- Used ReportLab's SimpleDocTemplate, Paragraph, Table, and TableStyle for PDF generation

**Files changed:**
- backend/src/app/routers/alerts.py

**Learnings for future iterations:**
- When generating PDF reports for list-based data (not single-item reports), calculate summary statistics before building PDF elements
- Group-by operations in Python can be done efficiently with simple dict accumulation: `by_type[key] = by_type.get(key, 0) + 1`
- Paragraph elements support HTML-like tags for formatting (e.g., `<b>`, `<br/>`)
- For alerts PDF export, use same filter pattern as CSV export: get all alerts with large limit (10000) instead of pagination
- The alerts_service.get_alerts() returns tuples of (alert, network_name), which is different from other services that return models directly
- Pre-existing mypy errors in other files (e.g., alerts.py line 514 in bulk_whitelist_network) are not blockers for new code that passes type checks
---

## 2026-01-27 - US-006
- Implemented GET /api/hosts/export/pdf endpoint
- PDF includes report header with generation timestamp
- PDF includes summary statistics: total hosts, breakdown by status (Up/Down/Unknown)
- PDF includes detailed table of hosts with columns: IP, Hostname, Status, First Seen, Last Seen, Open Ports
- Supports optional query params: network_id and is_pingable (aliased as "status") for filtering
- Filename format: hosts_{timestamp}.pdf
- Used ReportLab's SimpleDocTemplate, Paragraph, Table, and TableStyle for PDF generation

**Files changed:**
- backend/src/app/routers/hosts.py

**Learnings for future iterations:**
- When using long list literals that exceed line length (E501), extract them to a variable first
- For hosts PDF export, use same filter pattern as CSV export and reuse status calculation logic
- The status field is derived from is_pingable: null = "Unknown", true = "Up", false = "Down"
- For each host, need to fetch open port count using hosts_service.get_open_port_count_for_host()
- Pre-existing mypy errors in services layer (e.g., hosts.py) are not blockers for new router code
---

## 2026-01-27 - US-007
- Implemented Export dropdown button on ScanDetail page
- Added dropdown with "Export as CSV" and "Export as PDF" options
- Positioned next to "Back to scans" button in the header
- Implemented handleExportCsv and handleExportPdf functions using fetch API with blob download pattern
- Added loading state ("Exporting...") during export operations
- Added toast notification system with auto-dismiss after 3 seconds
- Toast shows success/error messages for export operations
- Dropdown closes automatically when export is triggered

**Files changed:**
- frontend/src/pages/ScanDetail.tsx

**Learnings for future iterations:**
- Frontend export pattern: Use fetch with getAuthHeaders, convert response to blob, create object URL, trigger download with createElement('a'), then revoke URL
- Toast notification pattern: useState for toast state, useEffect with setTimeout for auto-dismiss after 3 seconds
- Dropdown pattern: useState for visibility, position with "absolute right-0 top-full z-20 mt-2" classes
- Loading states: Show "Exporting..." text and disable button during async operations
- Timestamp format for filenames: new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19)
- Import API_BASE_URL and getAuthHeaders from '../lib/api' for authenticated fetch calls
- Toast styling uses fixed positioning (top-8 right-8) with z-[100] to appear above all content
---

## 2026-01-27 - US-008
- Implemented Export dropdown button on RiskOverview page
- Added dropdown with "Export as CSV" and "Export as PDF" options
- Positioned next to "Resolve" button in the header area
- Implemented handleExportCsv and handleExportPdf functions using fetch API with blob download pattern
- Added loading state ("Exporting...") during export operations
- Integrated with existing toast notification system for success/error messages
- Export functions respect current filters (severity and status filters)
- Dropdown closes automatically when export is triggered
- Typecheck passes

**Files changed:**
- frontend/src/pages/RiskOverview.tsx

**Learnings for future iterations:**
- Export dropdown follows same pattern as ScanDetail page (US-007)
- RiskOverview page has more complex filter state (severityFilter, statusFilter, networkFilter, searchQuery)
- When exporting with filters, map UI filter states to API query params (e.g., statusFilter='pending' → acknowledged=false)
- The statusFilter has multiple values ('all', 'blocked', 'pending', 'approved', 'monitoring') but only 'pending' and 'monitoring' map to acknowledged param
- Positioned Export button after Resolve button and before Policy/Back to dashboard links
- Toast notification state already exists in RiskOverview (reused existing implementation)
- Browser testing requires valid authentication credentials - manual testing recommended for full verification
---

## 2026-01-27 - US-009
- Implemented Export dropdown button on Hosts page
- Added dropdown with "Export as CSV" and "Export as PDF" options
- Positioned before admin-only controls (network selection and discovery button) in header
- Implemented handleExportCsv and handleExportPdf functions using fetch API with blob download pattern
- Export functions respect current filters: network_id and pingable status filters
- Filter mapping: pingableFilter='yes' → status=true, pingableFilter='no' → status=false
- Added loading state ("Exporting...") during export operations
- Reused existing toast notification system for success/error messages
- Dropdown closes automatically when export is triggered
- Typecheck passes

**Files changed:**
- frontend/src/pages/Hosts.tsx

**Learnings for future iterations:**
- Export dropdown follows same pattern as ScanDetail (US-007) and RiskOverview (US-008) pages
- Hosts page has simpler filter state compared to RiskOverview (networkFilter and pingableFilter)
- Filter parameter name mapping: pingableFilter uses 'status' query param (not 'is_pingable') for the export endpoints
- Positioned Export button to be accessible to all users (not just admins), placed before admin-specific discovery controls
- Toast notification state already exists in Hosts page (reused existing implementation like other pages)
- Export dropdown should be visible to all authenticated users, not just admins, for reporting purposes
---

