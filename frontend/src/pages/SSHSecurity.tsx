import { Card, Badge, Button, PageHeader, EmptyState } from '../components/ui'
import { formatDateTime, parseUtcDate, formatRelativeTime } from '../lib/dates'
import { useState, useMemo } from 'react'
import { useQuery, useQueryClient, useMutation } from '@tanstack/react-query'
import { useNavigate } from 'react-router-dom'
import { useAuth } from '../context/AuthContext'
import { API_BASE_URL, fetchJson, getAuthHeaders, extractErrorMessage } from '../lib/api'
import type { NetworkListResponse, SSHHostListResponse, SSHHostSummary, SSHAlertConfig } from '../types'

// Parse SSH version string to extract major.minor version number
const parseSSHVersion = (versionStr: string | null): number | null => {
  if (!versionStr) return null
  // Common patterns: "OpenSSH_8.9p1", "SSH-2.0-OpenSSH_7.6p1", "dropbear_2022.82"
  const openSSHMatch = versionStr.match(/OpenSSH[_\s]?(\d+)\.(\d+)/i)
  if (openSSHMatch) {
    return parseFloat(`${openSSHMatch[1]}.${openSSHMatch[2]}`)
  }
  return null
}

const DEFAULT_MIN_SSH_VERSION = 8.0

type FilterType = 'all' | 'insecure_auth' | 'weak_ciphers' | 'outdated_version'
type SortKey = 'ip' | 'port' | 'ssh_version' | 'auth' | 'change' | 'last_scanned'
type SortDirection = 'asc' | 'desc'
type AuthFilterType = 'all' | 'secure' | 'insecure'

const SSHSecurity = () => {
  const { token } = useAuth()
  const navigate = useNavigate()
  const queryClient = useQueryClient()
  const now = new Date()
  const [activeFilter, setActiveFilter] = useState<FilterType>('all')
  const [networkFilter, setNetworkFilter] = useState<number | null>(null)
  const [authFilter, setAuthFilter] = useState<AuthFilterType>('all')
  const [sortKey, setSortKey] = useState<SortKey>('last_scanned')
  const [sortDirection, setSortDirection] = useState<SortDirection>('desc')
  const [isExporting, setIsExporting] = useState(false)
  const [toast, setToast] = useState<{ message: string; tone: 'success' | 'error' } | null>(null)
  const [showGlobalSettings, setShowGlobalSettings] = useState(false)
  const [globalSettings, setGlobalSettings] = useState<SSHAlertConfig>({
    ssh_insecure_auth: true,
    ssh_weak_cipher: false,
    ssh_weak_kex: false,
    ssh_outdated_version: false,
    ssh_config_regression: true,
    ssh_version_threshold: '8.0.0',
  })
  const [globalSettingsError, setGlobalSettingsError] = useState<string | null>(null)

  // Fetch networks for filter dropdown
  const networksQuery = useQuery({
    queryKey: ['networks'],
    queryFn: () => fetchJson<NetworkListResponse>('/api/networks', token ?? ''),
    enabled: Boolean(token),
  })

  // Fetch global SSH alert defaults
  const globalDefaultsQuery = useQuery({
    queryKey: ['ssh-alert-defaults'],
    queryFn: () => fetchJson<SSHAlertConfig>('/api/settings/ssh-alert-defaults', token ?? ''),
    enabled: Boolean(token),
  })

  // Mutation to update global SSH alert defaults
  const updateGlobalDefaultsMutation = useMutation({
    mutationFn: async (settings: SSHAlertConfig) => {
      const response = await fetch(`${API_BASE_URL}/api/settings/ssh-alert-defaults`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
          ...getAuthHeaders(token ?? ''),
        },
        body: JSON.stringify(settings),
      })
      if (!response.ok) throw new Error(await extractErrorMessage(response))
      return response.json()
    },
    onSuccess: async () => {
      setShowGlobalSettings(false)
      setGlobalSettingsError(null)
      await queryClient.invalidateQueries({ queryKey: ['ssh-alert-defaults'] })
      setToast({ message: 'Global SSH alert defaults updated successfully', tone: 'success' })
    },
    onError: (error) =>
      setGlobalSettingsError(error instanceof Error ? error.message : 'Failed to save settings'),
  })

  // Fetch all SSH hosts (up to 200 for summary statistics)
  const sshHostsQuery = useQuery({
    queryKey: ['ssh-hosts', 'all'],
    queryFn: () => fetchJson<SSHHostListResponse>('/api/ssh/hosts?limit=200', token ?? ''),
    enabled: Boolean(token),
  })

  const recheckSSHMutation = useMutation({
    mutationFn: async ({ hostIp, port }: { hostIp: string; port: number }) => {
      const res = await fetch(
        `${API_BASE_URL}/api/ssh/hosts/${encodeURIComponent(hostIp)}/recheck?port=${port}`,
        {
          method: 'POST',
          headers: getAuthHeaders(token ?? ''),
        }
      )
      if (!res.ok) throw new Error(await extractErrorMessage(res))
      return res.json()
    },
    onSuccess: (_, { hostIp }) => {
      queryClient.invalidateQueries({ queryKey: ['ssh-hosts'] })
      setToast({ message: `SSH recheck started for ${hostIp}`, tone: 'success' })
    },
    onError: (e) =>
      setToast({ message: e instanceof Error ? e.message : 'Error', tone: 'error' }),
  })

  const hosts = useMemo(
    () => sshHostsQuery.data?.hosts ?? [],
    [sshHostsQuery.data?.hosts]
  )
  const totalHosts = sshHostsQuery.data?.total ?? 0

  // Compute metrics from hosts data
  const metrics = useMemo(() => {
    const hostsWithInsecureAuth = hosts.filter(
      (h) => h.password_enabled || h.keyboard_interactive_enabled
    )
    const hostsWithWeakCiphers = hosts.filter((h) => h.has_weak_ciphers || h.has_weak_kex)
    const hostsWithOutdatedVersion = hosts.filter((h) => {
      const version = parseSSHVersion(h.ssh_version)
      return version !== null && version < DEFAULT_MIN_SSH_VERSION
    })

    return {
      totalHosts,
      insecureAuthCount: hostsWithInsecureAuth.length,
      weakCiphersCount: hostsWithWeakCiphers.length,
      outdatedVersionCount: hostsWithOutdatedVersion.length,
      hostsWithInsecureAuth,
      hostsWithWeakCiphers,
      hostsWithOutdatedVersion,
    }
  }, [hosts, totalHosts])

  // Filter hosts based on selected card, network, and auth status
  const filteredHosts = useMemo(() => {
    let result: SSHHostSummary[]

    // Apply card filter first
    switch (activeFilter) {
      case 'insecure_auth':
        result = metrics.hostsWithInsecureAuth
        break
      case 'weak_ciphers':
        result = metrics.hostsWithWeakCiphers
        break
      case 'outdated_version':
        result = metrics.hostsWithOutdatedVersion
        break
      default:
        result = hosts
    }

    // Apply network filter
    if (networkFilter !== null) {
      result = result.filter((h) => h.network_id === networkFilter)
    }

    // Apply auth method filter
    if (authFilter === 'secure') {
      result = result.filter(
        (h) => h.publickey_enabled && !h.password_enabled && !h.keyboard_interactive_enabled
      )
    } else if (authFilter === 'insecure') {
      result = result.filter((h) => h.password_enabled || h.keyboard_interactive_enabled)
    }

    return result
  }, [activeFilter, hosts, metrics, networkFilter, authFilter])

  // Sort filtered hosts
  const sortedHosts = useMemo(() => {
    const sorted = [...filteredHosts]
    sorted.sort((a, b) => {
      let cmp = 0
      switch (sortKey) {
        case 'ip':
          cmp = a.host_ip.localeCompare(b.host_ip)
          break
        case 'port':
          cmp = a.port - b.port
          break
        case 'ssh_version':
          cmp = (a.ssh_version ?? '').localeCompare(b.ssh_version ?? '')
          break
        case 'auth': {
          const aInsecure = a.password_enabled || a.keyboard_interactive_enabled ? 1 : 0
          const bInsecure = b.password_enabled || b.keyboard_interactive_enabled ? 1 : 0
          cmp = bInsecure - aInsecure // Insecure first by default
          break
        }
        case 'change': {
          // Sort order: degraded (highest priority) > improved > unchanged > new (null)
          const changeOrder = (status: string | null) => {
            if (status === 'degraded') return 3
            if (status === 'improved') return 2
            if (status === 'unchanged') return 1
            return 0 // null (new)
          }
          cmp = changeOrder(a.change_status) - changeOrder(b.change_status)
          break
        }
        case 'last_scanned':
          cmp = new Date(a.last_scanned).getTime() - new Date(b.last_scanned).getTime()
          break
      }
      return sortDirection === 'asc' ? cmp : -cmp
    })
    return sorted
  }, [filteredHosts, sortKey, sortDirection])

  const summaryCards = [
    {
      id: 'all' as FilterType,
      label: 'Total SSH Hosts',
      value: metrics.totalHosts,
      detail: 'Discovered SSH services',
      accent: 'text-cyan-600 dark:text-cyan-200',
      borderAccent: 'border-cyan-500',
      bgAccent: 'bg-cyan-500/10',
    },
    {
      id: 'insecure_auth' as FilterType,
      label: 'Insecure Auth',
      value: metrics.insecureAuthCount,
      detail: 'Password or keyboard-interactive enabled',
      accent: 'text-rose-600 dark:text-rose-200',
      borderAccent: 'border-rose-500',
      bgAccent: 'bg-rose-500/10',
    },
    {
      id: 'weak_ciphers' as FilterType,
      label: 'Weak Ciphers',
      value: metrics.weakCiphersCount,
      detail: 'Weak ciphers or KEX algorithms',
      accent: 'text-amber-600 dark:text-amber-200',
      borderAccent: 'border-amber-500',
      bgAccent: 'bg-amber-500/10',
    },
    {
      id: 'outdated_version' as FilterType,
      label: 'Outdated Version',
      value: metrics.outdatedVersionCount,
      detail: `SSH version < ${DEFAULT_MIN_SSH_VERSION}`,
      accent: 'text-orange-600 dark:text-orange-200',
      borderAccent: 'border-orange-500',
      bgAccent: 'bg-orange-500/10',
    },
  ]

  const filterLabels: Record<FilterType, string> = {
    all: 'All SSH Hosts',
    insecure_auth: 'Hosts with Insecure Authentication',
    weak_ciphers: 'Hosts with Weak Ciphers',
    outdated_version: 'Hosts with Outdated SSH Version',
  }

  const isLoading = sshHostsQuery.isLoading
  const hasError = sshHostsQuery.isError

  const handleSort = (key: SortKey) => {
    if (sortKey === key) {
      setSortDirection((d) => (d === 'asc' ? 'desc' : 'asc'))
    } else {
      setSortKey(key)
      setSortDirection('asc')
    }
  }

  const renderSortHeader = (label: string, key: SortKey) => (
    <button
      type="button"
      onClick={() => handleSort(key)}
      className="flex items-center gap-1 text-xs font-semibold text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200 transition-colors"
    >
      {label}
      {sortKey === key && (
        <span className="text-cyan-500">{sortDirection === 'asc' ? '↑' : '↓'}</span>
      )}
    </button>
  )

  const handleRowClick = (host: SSHHostSummary) => {
    // Navigate to hosts page with IP filter
    navigate(`/hosts?ip=${encodeURIComponent(host.host_ip)}`)
  }

  const handleExportPdf = async () => {
    setIsExporting(true)
    try {
      const queryParams = new URLSearchParams()
      if (networkFilter !== null) queryParams.append('network_id', networkFilter.toString())

      const url = `${API_BASE_URL}/api/ssh/export/pdf${queryParams.toString() ? `?${queryParams.toString()}` : ''}`
      const response = await fetch(url, { headers: getAuthHeaders(token ?? '') })

      if (!response.ok) throw new Error(await extractErrorMessage(response))

      const blob = await response.blob()
      const downloadUrl = window.URL.createObjectURL(blob)
      const link = document.createElement('a')
      link.href = downloadUrl
      link.download = `ssh_security_report_${new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19)}.pdf`
      document.body.appendChild(link)
      link.click()
      document.body.removeChild(link)
      window.URL.revokeObjectURL(downloadUrl)

      setToast({ message: 'SSH Security Report exported successfully', tone: 'success' })
    } catch (error) {
      setToast({
        message: error instanceof Error ? error.message : 'Export failed',
        tone: 'error',
      })
    } finally {
      setIsExporting(false)
    }
  }

  const handleExportCsv = async () => {
    setIsExporting(true)
    try {
      const queryParams = new URLSearchParams()
      if (networkFilter !== null) queryParams.append('network_id', networkFilter.toString())

      const url = `${API_BASE_URL}/api/ssh/export/csv${queryParams.toString() ? `?${queryParams.toString()}` : ''}`
      const response = await fetch(url, { headers: getAuthHeaders(token ?? '') })

      if (!response.ok) throw new Error(await extractErrorMessage(response))

      const blob = await response.blob()
      const downloadUrl = window.URL.createObjectURL(blob)
      const link = document.createElement('a')
      link.href = downloadUrl
      // Filename with date: ssh-security-YYYY-MM-DD.csv
      const dateStr = new Date().toISOString().slice(0, 10)
      link.download = `ssh-security-${dateStr}.csv`
      document.body.appendChild(link)
      link.click()
      document.body.removeChild(link)
      window.URL.revokeObjectURL(downloadUrl)

      setToast({ message: 'CSV exported successfully', tone: 'success' })
    } catch (error) {
      setToast({
        message: error instanceof Error ? error.message : 'CSV export failed',
        tone: 'error',
      })
    } finally {
      setIsExporting(false)
    }
  }

  // Auto-dismiss toast after 3 seconds
  if (toast) {
    setTimeout(() => setToast(null), 3000)
  }

  const openGlobalSettingsModal = () => {
    if (!globalDefaultsQuery.data) return
    setGlobalSettingsError(null)
    setGlobalSettings({
      ssh_insecure_auth: globalDefaultsQuery.data.ssh_insecure_auth ?? true,
      ssh_weak_cipher: globalDefaultsQuery.data.ssh_weak_cipher ?? false,
      ssh_weak_kex: globalDefaultsQuery.data.ssh_weak_kex ?? false,
      ssh_outdated_version: globalDefaultsQuery.data.ssh_outdated_version ?? false,
      ssh_config_regression: globalDefaultsQuery.data.ssh_config_regression ?? true,
      ssh_version_threshold: globalDefaultsQuery.data.ssh_version_threshold ?? '8.0.0',
    })
    setShowGlobalSettings(true)
  }

  const handleGlobalSettingsSubmit = (event: React.FormEvent<HTMLFormElement>) => {
    event.preventDefault()
    setGlobalSettingsError(null)
    if (!token) return
    updateGlobalDefaultsMutation.mutate(globalSettings)
  }

  const getAuthMethodBadge = (host: SSHHostSummary) => {
    if (host.password_enabled || host.keyboard_interactive_enabled) {
      return (
        <span className="inline-flex items-center rounded-full border border-rose-400/40 bg-rose-500/15 px-2 py-0.5 text-xs font-semibold text-rose-700 dark:text-rose-200">
          Insecure
        </span>
      )
    }
    if (host.publickey_enabled) {
      return (
        <span className="inline-flex items-center rounded-full border border-emerald-400/40 bg-emerald-500/15 px-2 py-0.5 text-xs font-semibold text-emerald-700 dark:text-emerald-200">
          Key Only
        </span>
      )
    }
    return (
      <span className="inline-flex items-center rounded-full border border-slate-400/40 bg-slate-500/15 px-2 py-0.5 text-xs font-semibold text-slate-600 dark:text-slate-300">
        Unknown
      </span>
    )
  }

  const getWeaknessBadge = (host: SSHHostSummary) => {
    const hasWeakness = host.has_weak_ciphers || host.has_weak_kex
    if (hasWeakness) {
      return (
        <span className="inline-flex items-center rounded-full border border-amber-400/40 bg-amber-500/15 px-2 py-0.5 text-xs font-semibold text-amber-700 dark:text-amber-200">
          Weak Crypto
        </span>
      )
    }
    return (
      <span className="inline-flex items-center rounded-full border border-emerald-400/40 bg-emerald-500/15 px-2 py-0.5 text-xs font-semibold text-emerald-700 dark:text-emerald-200">
        Secure
      </span>
    )
  }

  const getVersionBadge = (host: SSHHostSummary) => {
    const version = parseSSHVersion(host.ssh_version)
    const isOutdated = version !== null && version < DEFAULT_MIN_SSH_VERSION
    if (isOutdated) {
      return (
        <span className="inline-flex items-center rounded-full border border-orange-400/40 bg-orange-500/15 px-2 py-0.5 text-xs font-semibold text-orange-700 dark:text-orange-200">
          Outdated
        </span>
      )
    }
    if (version !== null) {
      return (
        <span className="inline-flex items-center rounded-full border border-emerald-400/40 bg-emerald-500/15 px-2 py-0.5 text-xs font-semibold text-emerald-700 dark:text-emerald-200">
          Current
        </span>
      )
    }
    return null
  }

  const getChangeBadge = (host: SSHHostSummary) => {
    if (!host.change_status) {
      // No prior scan data
      return (
        <span className="inline-flex items-center rounded-full border border-slate-300/40 bg-slate-100/50 px-2 py-0.5 text-xs font-semibold text-slate-500 dark:border-slate-600/40 dark:bg-slate-800/50 dark:text-slate-400">
          New
        </span>
      )
    }

    if (host.change_status === 'unchanged') {
      return (
        <span className="inline-flex items-center rounded-full border border-slate-300/40 bg-slate-100/50 px-2 py-0.5 text-xs font-semibold text-slate-500 dark:border-slate-600/40 dark:bg-slate-800/50 dark:text-slate-400">
          —
        </span>
      )
    }

    if (host.change_status === 'improved') {
      return (
        <span
          className="group relative inline-flex cursor-help items-center gap-1 rounded-full border border-emerald-400/40 bg-emerald-500/15 px-2 py-0.5 text-xs font-semibold text-emerald-700 dark:text-emerald-200"
          title={host.changes.map((c) => c.description).join('\n')}
        >
          <svg
            className="h-3 w-3"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M5 10l7-7m0 0l7 7m-7-7v18"
            />
          </svg>
          Improved
        </span>
      )
    }

    // degraded
    return (
      <span
        className="group relative inline-flex cursor-help items-center gap-1 rounded-full border border-rose-400/40 bg-rose-500/15 px-2 py-0.5 text-xs font-semibold text-rose-700 dark:text-rose-200"
        title={host.changes.map((c) => c.description).join('\n')}
      >
        <svg
          className="h-3 w-3"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            strokeLinecap="round"
            strokeLinejoin="round"
            strokeWidth={2}
            d="M19 14l-7 7m0 0l-7-7m7 7V3"
          />
        </svg>
        Degraded
      </span>
    )
  }

  const getChangeTooltipContent = (host: SSHHostSummary) => {
    if (!host.change_status || host.change_status === 'unchanged' || host.changes.length === 0) {
      return null
    }
    return (
      <div className="absolute bottom-full left-1/2 z-50 mb-2 hidden w-64 -translate-x-1/2 rounded-lg border border-slate-200/70 bg-white p-3 text-left text-xs shadow-lg group-hover:block dark:border-slate-700/70 dark:bg-slate-900">
        <p className="mb-2 font-semibold text-slate-700 dark:text-slate-200">
          Changes since last scan:
        </p>
        <ul className="space-y-1">
          {host.changes.map((change, idx) => (
            <li
              key={idx}
              className={`flex items-start gap-2 ${
                change.is_regression
                  ? 'text-rose-600 dark:text-rose-300'
                  : 'text-emerald-600 dark:text-emerald-300'
              }`}
            >
              <span className="mt-0.5">
                {change.is_regression ? (
                  <svg className="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                  </svg>
                ) : (
                  <svg className="h-3 w-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 10l7-7m0 0l7 7m-7-7v18" />
                  </svg>
                )}
              </span>
              <span>{change.description}</span>
            </li>
          ))}
        </ul>
        <div className="absolute -bottom-1.5 left-1/2 -translate-x-1/2 border-8 border-transparent border-t-white dark:border-t-slate-900" />
      </div>
    )
  }

  return (
    <div className="relative">
      {/* Background decorations */}
      <div className="pointer-events-none absolute -left-24 top-12 h-72 w-72 animate-drift rounded-full bg-cyan-500/20 blur-[120px]" />
      <div className="pointer-events-none absolute right-0 top-40 h-72 w-72 animate-drift rounded-full bg-rose-500/15 blur-[140px]" />
      <div className="pointer-events-none absolute -bottom-32 left-1/3 h-72 w-72 animate-drift rounded-full bg-amber-500/10 blur-[160px]" />

      <section className="relative z-10 space-y-8">
        {/* Header section */}
        <div className="animate-rise rounded-3xl border border-slate-200/60 bg-white/80 p-8 shadow-[0_20px_80px_rgba(15,23,42,0.12)] backdrop-blur dark:border-slate-800/60 dark:bg-slate-950/70">
          <div className="flex flex-col gap-4 md:flex-row md:items-end md:justify-between">
            <div>
              <p className="text-xs font-semibold text-slate-500 dark:text-slate-400">
                Security Analysis
              </p>
              <h2 className="mt-3 font-display text-3xl text-slate-900 dark:text-white">
                SSH Security Dashboard
              </h2>
              <p className="mt-2 max-w-2xl text-sm text-slate-600 dark:text-slate-300">
                Monitor SSH configurations across your infrastructure. Identify hosts with insecure
                authentication methods, weak ciphers, or outdated versions.
              </p>
            </div>
            <div className="flex items-center gap-3">
              <button
                onClick={openGlobalSettingsModal}
                disabled={!globalDefaultsQuery.data}
                className="rounded-full border border-violet-200 bg-violet-500/10 px-4 py-2 text-xs font-semibold text-violet-700 transition hover:border-violet-300 hover:bg-violet-500/20 dark:border-violet-500/40 dark:text-violet-300 disabled:cursor-not-allowed disabled:opacity-50"
              >
                Alert Settings
              </button>
              <button
                onClick={handleExportCsv}
                disabled={isExporting || isLoading || totalHosts === 0}
                className="rounded-full border border-cyan-200 bg-cyan-500/10 px-4 py-2 text-xs font-semibold text-cyan-700 transition hover:border-cyan-300 hover:bg-cyan-500/20 dark:border-cyan-500/40 dark:text-cyan-300 disabled:cursor-not-allowed disabled:opacity-50"
              >
                {isExporting ? 'Exporting...' : 'Export CSV'}
              </button>
              <button
                onClick={handleExportPdf}
                disabled={isExporting || isLoading || totalHosts === 0}
                className="rounded-full border border-emerald-200 bg-emerald-500/10 px-4 py-2 text-xs font-semibold text-emerald-700 transition hover:border-emerald-300 hover:bg-emerald-500/20 dark:border-emerald-500/40 dark:text-emerald-300 disabled:cursor-not-allowed disabled:opacity-50"
              >
                {isExporting ? 'Exporting...' : 'Export PDF'}
              </button>
              <div className="rounded-2xl border border-slate-200/70 bg-slate-50/80 px-4 py-3 text-xs text-slate-500 shadow-sm dark:border-slate-800/80 dark:bg-slate-900/60 dark:text-slate-300">
                {isLoading ? 'Loading SSH data...' : `Updated ${formatDateTime(now)}`}
              </div>
            </div>
          </div>

          {/* Summary Cards */}
          <div className="mt-8 grid gap-4 md:grid-cols-2 xl:grid-cols-4">
            {summaryCards.map((card, index) => (
              <button
                key={card.id}
                type="button"
                onClick={() => setActiveFilter(card.id)}
                style={{ animationDelay: `${index * 0.08}s` }}
                className={`group animate-rise rounded-2xl border p-5 text-left shadow-sm transition duration-300 hover:-translate-y-1 hover:shadow-lg ${
                  activeFilter === card.id
                    ? `${card.borderAccent} ${card.bgAccent} dark:border-opacity-60`
                    : 'border-slate-200/70 bg-white/80 dark:border-slate-800/70 dark:bg-slate-900/70'
                }`}
              >
                <p className="text-xs text-slate-500 dark:text-slate-400">{card.label}</p>
                <div className="mt-3 flex items-baseline gap-2">
                  <span className={`text-2xl font-semibold ${card.accent}`}>
                    {isLoading || hasError ? '—' : card.value}
                  </span>
                </div>
                <p className="mt-2 text-xs text-slate-500 dark:text-slate-400">{card.detail}</p>
              </button>
            ))}
          </div>
        </div>

        {/* Filtered Hosts Table */}
        <div className="animate-rise rounded-3xl border border-slate-200/70 bg-white/80 p-6 shadow-sm dark:border-slate-800/70 dark:bg-slate-950/70">
          <div className="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
            <h3 className="font-display text-xl text-slate-900 dark:text-white">
              {filterLabels[activeFilter]}
            </h3>
            <span className="rounded-full border border-slate-200/70 bg-slate-100/80 px-3 py-1 text-xs font-semibold text-slate-600 dark:border-slate-700/70 dark:bg-slate-800/80 dark:text-slate-300">
              {sortedHosts.length} host{sortedHosts.length !== 1 ? 's' : ''}
            </span>
          </div>

          {/* Filter Controls */}
          <div className="mt-4 flex flex-wrap items-center gap-4">
            <div className="flex flex-col gap-1">
              <label className="text-[10px] font-semibold uppercase tracking-wider text-slate-400">
                Network
              </label>
              <select
                value={networkFilter ?? ''}
                onChange={(e) => setNetworkFilter(e.target.value ? Number(e.target.value) : null)}
                className="rounded-xl border border-slate-200/70 bg-white px-3 py-2 text-xs font-medium text-slate-700 shadow-sm transition-colors focus:border-cyan-500 focus:outline-none focus:ring-2 focus:ring-cyan-500/20 dark:border-slate-700/70 dark:bg-slate-900 dark:text-slate-200"
              >
                <option value="">All Networks</option>
                {(networksQuery.data?.networks ?? []).map((n) => (
                  <option key={n.id} value={n.id}>
                    {n.name}
                  </option>
                ))}
              </select>
            </div>
            <div className="flex flex-col gap-1">
              <label className="text-[10px] font-semibold uppercase tracking-wider text-slate-400">
                Auth Status
              </label>
              <select
                value={authFilter}
                onChange={(e) => setAuthFilter(e.target.value as AuthFilterType)}
                className="rounded-xl border border-slate-200/70 bg-white px-3 py-2 text-xs font-medium text-slate-700 shadow-sm transition-colors focus:border-cyan-500 focus:outline-none focus:ring-2 focus:ring-cyan-500/20 dark:border-slate-700/70 dark:bg-slate-900 dark:text-slate-200"
              >
                <option value="all">All Auth</option>
                <option value="secure">Secure (Key Only)</option>
                <option value="insecure">Insecure (Password/Kbd)</option>
              </select>
            </div>
          </div>

          {hasError ? (
            <div className="mt-4 rounded-2xl border border-rose-200/70 bg-rose-50/80 px-4 py-3 text-sm text-rose-700 dark:border-rose-500/40 dark:bg-rose-500/10 dark:text-rose-100">
              Unable to load SSH hosts data.
            </div>
          ) : isLoading ? (
            <div className="mt-4 rounded-2xl border border-slate-200/70 bg-slate-50/80 px-4 py-3 text-sm text-slate-500 dark:border-slate-800/70 dark:bg-slate-900/60 dark:text-slate-400">
              Loading SSH hosts...
            </div>
          ) : sortedHosts.length === 0 ? (
            <div className="mt-4 rounded-2xl border border-slate-200/70 bg-slate-50/80 px-4 py-3 text-sm text-slate-500 dark:border-slate-800/70 dark:bg-slate-900/60 dark:text-slate-400">
              {activeFilter === 'all' && networkFilter === null && authFilter === 'all'
                ? 'No SSH hosts discovered yet. Run a scan to discover SSH services.'
                : 'No hosts match the current filter criteria.'}
            </div>
          ) : (
            <div className="mt-4 overflow-x-auto">
              <table className="w-full">
                <thead>
                  <tr className="border-b border-slate-200/70 text-left dark:border-slate-800/70">
                    <th className="pb-3 pr-4">{renderSortHeader('IP', 'ip')}</th>
                    <th className="pb-3 pr-4">{renderSortHeader('Port', 'port')}</th>
                    <th className="pb-3 pr-4">{renderSortHeader('SSH Version', 'ssh_version')}</th>
                    <th className="pb-3 pr-4">{renderSortHeader('Auth', 'auth')}</th>
                    <th className="pb-3 pr-4 text-xs font-semibold text-slate-500 dark:text-slate-400">
                      Crypto
                    </th>
                    <th className="pb-3 pr-4">{renderSortHeader('Change', 'change')}</th>
                    <th className="pb-3 pr-4 text-xs font-semibold text-slate-500 dark:text-slate-400">
                      Network
                    </th>
                    <th className="pb-3 pr-4">{renderSortHeader('Last Scanned', 'last_scanned')}</th>
                    <th className="pb-3 text-xs font-semibold text-slate-500 dark:text-slate-400">
                      Actions
                    </th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-slate-200/50 dark:divide-slate-800/50">
                  {sortedHosts.map((host) => (
                    <tr
                      key={`${host.host_ip}:${host.port}`}
                      onClick={() => handleRowClick(host)}
                      className="cursor-pointer text-sm transition-colors hover:bg-cyan-50/50 dark:hover:bg-cyan-900/10"
                    >
                      <td className="py-3 pr-4">
                        <span className="font-semibold text-slate-900 dark:text-white">
                          {host.host_ip}
                        </span>
                      </td>
                      <td className="py-3 pr-4">
                        <span className="text-slate-600 dark:text-slate-300">{host.port}</span>
                      </td>
                      <td className="py-3 pr-4">
                        <div className="flex items-center gap-2">
                          <span className="text-slate-700 dark:text-slate-200">
                            {host.ssh_version ?? 'Unknown'}
                          </span>
                          {getVersionBadge(host)}
                        </div>
                      </td>
                      <td className="py-3 pr-4">{getAuthMethodBadge(host)}</td>
                      <td className="py-3 pr-4">{getWeaknessBadge(host)}</td>
                      <td className="py-3 pr-4">
                        <div className="group relative inline-block">
                          {getChangeBadge(host)}
                          {getChangeTooltipContent(host)}
                        </div>
                      </td>
                      <td className="py-3 pr-4">
                        <span className="text-slate-600 dark:text-slate-300">
                          {host.network_name ?? 'Unknown'}
                        </span>
                      </td>
                      <td className="py-3 pr-4">
                        <span
                          className="text-slate-500 dark:text-slate-400"
                          title={formatDateTime(parseUtcDate(host.last_scanned))}
                        >
                          {formatRelativeTime(parseUtcDate(host.last_scanned), now)}
                        </span>
                      </td>
                      <td className="py-3">
                        <button
                          onClick={(e) => {
                            e.stopPropagation()
                            recheckSSHMutation.mutate({ hostIp: host.host_ip, port: host.port })
                          }}
                          disabled={recheckSSHMutation.isPending}
                          className="rounded-lg border border-emerald-200 bg-emerald-500/10 px-3 py-1 text-xs font-semibold text-emerald-700 transition hover:border-emerald-300 hover:bg-emerald-500/20 dark:border-emerald-500/40 dark:text-emerald-300 disabled:cursor-not-allowed disabled:opacity-50"
                          title="Recheck SSH security for this host"
                        >
                          {recheckSSHMutation.isPending ? 'Checking...' : 'Recheck'}
                        </button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          )}
        </div>
      </section>

      {/* Global SSH Alert Settings Modal */}
      {showGlobalSettings && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm">
          <div className="mx-4 w-full max-w-2xl animate-rise rounded-3xl border border-slate-200/70 bg-white p-8 shadow-2xl dark:border-slate-800/70 dark:bg-slate-950">
            <div className="flex items-center justify-between">
              <div>
                <h3 className="font-display text-2xl text-slate-900 dark:text-white">
                  Global SSH Alert Settings
                </h3>
                <p className="mt-1 text-sm text-slate-500 dark:text-slate-400">
                  Configure default SSH security alert settings for all networks
                </p>
              </div>
              <button
                type="button"
                onClick={() => setShowGlobalSettings(false)}
                className="rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold text-slate-600 transition hover:border-slate-300 hover:bg-slate-100 dark:border-slate-800 dark:text-slate-300 dark:hover:border-slate-700 dark:hover:bg-slate-900"
              >
                Close
              </button>
            </div>
            <form className="mt-6 space-y-5" onSubmit={handleGlobalSettingsSubmit}>
              <p className="text-sm text-slate-500 dark:text-slate-400">
                These settings apply to networks that use default alert configuration. Networks with custom alert settings will not be affected.
              </p>

              {/* SSH Insecure Auth Toggle */}
              <div className="flex items-center justify-between rounded-2xl border border-slate-200/70 bg-slate-50/80 p-4 dark:border-slate-800/70 dark:bg-slate-900/60">
                <div>
                  <p className="text-sm font-semibold text-slate-900 dark:text-white">
                    Password/keyboard-interactive authentication
                  </p>
                  <p className="mt-1 text-xs text-slate-500 dark:text-slate-400">
                    Alert when SSH allows insecure authentication methods (HIGH severity)
                  </p>
                </div>
                <label className="relative inline-flex cursor-pointer items-center">
                  <input
                    type="checkbox"
                    checked={globalSettings.ssh_insecure_auth ?? true}
                    onChange={(e) =>
                      setGlobalSettings((v) => ({ ...v, ssh_insecure_auth: e.target.checked }))
                    }
                    className="peer sr-only"
                  />
                  <div className="peer h-6 w-11 rounded-full bg-slate-200 after:absolute after:left-[2px] after:top-[2px] after:h-5 after:w-5 after:rounded-full after:border after:border-slate-300 after:bg-white after:transition-all after:content-[''] peer-checked:bg-cyan-600 peer-checked:after:translate-x-full peer-checked:after:border-white peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-cyan-300 dark:border-slate-600 dark:bg-slate-700 dark:peer-focus:ring-cyan-800" />
                </label>
              </div>

              {/* SSH Weak Cipher Toggle */}
              <div className="flex items-center justify-between rounded-2xl border border-slate-200/70 bg-slate-50/80 p-4 dark:border-slate-800/70 dark:bg-slate-900/60">
                <div>
                  <p className="text-sm font-semibold text-slate-900 dark:text-white">
                    Weak ciphers detected
                  </p>
                  <p className="mt-1 text-xs text-slate-500 dark:text-slate-400">
                    Alert when weak encryption algorithms are enabled (MEDIUM severity)
                  </p>
                </div>
                <label className="relative inline-flex cursor-pointer items-center">
                  <input
                    type="checkbox"
                    checked={globalSettings.ssh_weak_cipher ?? false}
                    onChange={(e) =>
                      setGlobalSettings((v) => ({ ...v, ssh_weak_cipher: e.target.checked }))
                    }
                    className="peer sr-only"
                  />
                  <div className="peer h-6 w-11 rounded-full bg-slate-200 after:absolute after:left-[2px] after:top-[2px] after:h-5 after:w-5 after:rounded-full after:border after:border-slate-300 after:bg-white after:transition-all after:content-[''] peer-checked:bg-cyan-600 peer-checked:after:translate-x-full peer-checked:after:border-white peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-cyan-300 dark:border-slate-600 dark:bg-slate-700 dark:peer-focus:ring-cyan-800" />
                </label>
              </div>

              {/* SSH Weak KEX Toggle */}
              <div className="flex items-center justify-between rounded-2xl border border-slate-200/70 bg-slate-50/80 p-4 dark:border-slate-800/70 dark:bg-slate-900/60">
                <div>
                  <p className="text-sm font-semibold text-slate-900 dark:text-white">
                    Weak key exchange algorithms
                  </p>
                  <p className="mt-1 text-xs text-slate-500 dark:text-slate-400">
                    Alert when weak KEX algorithms are enabled (MEDIUM severity)
                  </p>
                </div>
                <label className="relative inline-flex cursor-pointer items-center">
                  <input
                    type="checkbox"
                    checked={globalSettings.ssh_weak_kex ?? false}
                    onChange={(e) =>
                      setGlobalSettings((v) => ({ ...v, ssh_weak_kex: e.target.checked }))
                    }
                    className="peer sr-only"
                  />
                  <div className="peer h-6 w-11 rounded-full bg-slate-200 after:absolute after:left-[2px] after:top-[2px] after:h-5 after:w-5 after:rounded-full after:border after:border-slate-300 after:bg-white after:transition-all after:content-[''] peer-checked:bg-cyan-600 peer-checked:after:translate-x-full peer-checked:after:border-white peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-cyan-300 dark:border-slate-600 dark:bg-slate-700 dark:peer-focus:ring-cyan-800" />
                </label>
              </div>

              {/* SSH Outdated Version Toggle */}
              <div className="flex items-center justify-between rounded-2xl border border-slate-200/70 bg-slate-50/80 p-4 dark:border-slate-800/70 dark:bg-slate-900/60">
                <div>
                  <p className="text-sm font-semibold text-slate-900 dark:text-white">
                    Outdated SSH version
                  </p>
                  <p className="mt-1 text-xs text-slate-500 dark:text-slate-400">
                    Alert when SSH version is below threshold (MEDIUM severity)
                  </p>
                </div>
                <label className="relative inline-flex cursor-pointer items-center">
                  <input
                    type="checkbox"
                    checked={globalSettings.ssh_outdated_version ?? false}
                    onChange={(e) =>
                      setGlobalSettings((v) => ({ ...v, ssh_outdated_version: e.target.checked }))
                    }
                    className="peer sr-only"
                  />
                  <div className="peer h-6 w-11 rounded-full bg-slate-200 after:absolute after:left-[2px] after:top-[2px] after:h-5 after:w-5 after:rounded-full after:border after:border-slate-300 after:bg-white after:transition-all after:content-[''] peer-checked:bg-cyan-600 peer-checked:after:translate-x-full peer-checked:after:border-white peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-cyan-300 dark:border-slate-600 dark:bg-slate-700 dark:peer-focus:ring-cyan-800" />
                </label>
              </div>

              {/* SSH Version Threshold */}
              <div className="rounded-2xl border border-slate-200/70 bg-slate-50/80 p-4 dark:border-slate-800/70 dark:bg-slate-900/60">
                <label className="block space-y-2 text-xs font-semibold text-slate-500 dark:text-slate-400">
                  SSH version threshold
                  <input
                    type="text"
                    placeholder="e.g., 8.0.0"
                    value={globalSettings.ssh_version_threshold ?? '8.0.0'}
                    onChange={(e) =>
                      setGlobalSettings((v) => ({ ...v, ssh_version_threshold: e.target.value }))
                    }
                    className="w-full rounded-2xl border border-slate-200/70 bg-white px-4 py-2 text-sm font-medium text-slate-900 shadow-sm focus:border-cyan-400 focus:outline-none dark:border-slate-800 dark:bg-slate-900 dark:text-slate-100"
                  />
                  <span className="text-[11px] font-medium text-slate-400 dark:text-slate-500">
                    Minimum acceptable SSH version (default: 8.0.0)
                  </span>
                </label>
              </div>

              {/* SSH Config Regression Toggle */}
              <div className="flex items-center justify-between rounded-2xl border border-slate-200/70 bg-slate-50/80 p-4 dark:border-slate-800/70 dark:bg-slate-900/60">
                <div>
                  <p className="text-sm font-semibold text-slate-900 dark:text-white">
                    Configuration regression
                  </p>
                  <p className="mt-1 text-xs text-slate-500 dark:text-slate-400">
                    Alert when SSH security configuration degrades between scans (HIGH severity)
                  </p>
                </div>
                <label className="relative inline-flex cursor-pointer items-center">
                  <input
                    type="checkbox"
                    checked={globalSettings.ssh_config_regression ?? true}
                    onChange={(e) =>
                      setGlobalSettings((v) => ({ ...v, ssh_config_regression: e.target.checked }))
                    }
                    className="peer sr-only"
                  />
                  <div className="peer h-6 w-11 rounded-full bg-slate-200 after:absolute after:left-[2px] after:top-[2px] after:h-5 after:w-5 after:rounded-full after:border after:border-slate-300 after:bg-white after:transition-all after:content-[''] peer-checked:bg-cyan-600 peer-checked:after:translate-x-full peer-checked:after:border-white peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-cyan-300 dark:border-slate-600 dark:bg-slate-700 dark:peer-focus:ring-cyan-800" />
                </label>
              </div>

              {globalSettingsError && (
                <div className="rounded-2xl border border-rose-200/70 bg-rose-50/80 px-4 py-3 text-sm text-rose-700 dark:border-rose-500/40 dark:bg-rose-500/10 dark:text-rose-100">
                  {globalSettingsError}
                </div>
              )}
              <div className="flex items-center justify-end gap-3">
                <button
                  type="button"
                  onClick={() => setShowGlobalSettings(false)}
                  className="rounded-full border border-slate-200 px-4 py-2 text-xs font-semibold text-slate-600 transition hover:border-slate-300 hover:bg-slate-100 dark:border-slate-800 dark:text-slate-300 dark:hover:border-slate-700 dark:hover:bg-slate-900"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  disabled={updateGlobalDefaultsMutation.isPending}
                  className="rounded-full border border-cyan-500 bg-cyan-600 px-4 py-2 text-xs font-semibold text-white shadow-md transition hover:bg-cyan-700 disabled:cursor-not-allowed disabled:opacity-50 dark:border-cyan-400 dark:bg-cyan-600 dark:hover:bg-cyan-500"
                >
                  {updateGlobalDefaultsMutation.isPending ? 'Saving...' : 'Save Global Defaults'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Toast notification */}
      {toast && (
        <div
          className={`fixed bottom-6 right-6 z-50 rounded-2xl border px-5 py-3 text-sm font-medium shadow-lg transition-all ${
            toast.tone === 'success'
              ? 'border-emerald-200 bg-emerald-50 text-emerald-700 dark:border-emerald-500/40 dark:bg-emerald-500/10 dark:text-emerald-300'
              : 'border-rose-200 bg-rose-50 text-rose-700 dark:border-rose-500/40 dark:bg-rose-500/10 dark:text-rose-300'
          }`}
        >
          {toast.message}
        </div>
      )}
    </div>
  )
}

export default SSHSecurity
