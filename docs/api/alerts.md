# Alerts API

The alerts API provides endpoints for managing security alerts generated by the scanning system. Alerts are created when the scanner detects open ports that match configured rules.

## Alert Types

| Type | Description |
|------|-------------|
| `new_port` | A new open port was detected that wasn't seen in previous scans |
| `not_allowed` | An open port violates network-specific port rules |
| `blocked` | An open port matches a global blocked port rule |

## Resolution Status

| Status | Description |
|--------|-------------|
| `open` | Alert is unresolved and requires attention |
| `in_progress` | Alert is being investigated |
| `resolved` | Alert has been addressed |

## Severity Levels

Severity is computed dynamically based on alert type and status:

| Severity | Criteria |
|----------|----------|
| `critical` | Blocked port or critical rule violation |
| `high` | New port not in whitelist |
| `medium` | Port not allowed by policy |
| `info` | Acknowledged alerts |

---

## List Alerts

Retrieve a paginated list of alerts with optional filtering.

```
GET /api/alerts
```

**Authentication:** Required (any authenticated user)

### Query Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `type` | string | No | Filter by alert type: `new_port`, `not_allowed`, `blocked` |
| `network_id` | integer | No | Filter by network ID (must be >= 1) |
| `acknowledged` | boolean | No | Filter by acknowledgment status |
| `start_date` | datetime | No | Filter alerts created on or after this date (ISO 8601 format) |
| `end_date` | datetime | No | Filter alerts created on or before this date (ISO 8601 format) |
| `offset` | integer | No | Pagination offset (default: 0, min: 0) |
| `limit` | integer | No | Results per page (default: 50, min: 1, max: 200) |

### Response

```json
{
  "alerts": [
    {
      "id": 1,
      "type": "new_port",
      "network_id": 1,
      "network_name": "Production",
      "global_open_port_id": null,
      "ip": "192.168.1.100",
      "port": 8080,
      "message": "New open port detected: 8080/tcp",
      "acknowledged": false,
      "assigned_to_user_id": null,
      "assigned_to_email": null,
      "resolution_status": "open",
      "created_at": "2026-01-27T10:30:00+00:00",
      "severity": "high",
      "host_id": 42,
      "hostname": "webserver-01",
      "user_comment": "Production web server"
    }
  ]
}
```

### Example

```bash
# List all unacknowledged alerts for a specific network
curl -X GET "http://localhost:8000/api/alerts?network_id=1&acknowledged=false&limit=100" \
  -H "Authorization: Bearer <token>"

# List blocked port alerts from the last 7 days
curl -X GET "http://localhost:8000/api/alerts?type=blocked&start_date=2026-01-20T00:00:00Z" \
  -H "Authorization: Bearer <token>"
```

---

## Acknowledge Alert

Mark a single alert as acknowledged.

```
PUT /api/alerts/{alert_id}/acknowledge
```

**Authentication:** Admin required

### Path Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `alert_id` | integer | The alert ID |

### Response

Returns the updated alert object with `acknowledged: true`.

```json
{
  "id": 1,
  "type": "new_port",
  "network_id": 1,
  "network_name": "Production",
  "global_open_port_id": null,
  "ip": "192.168.1.100",
  "port": 8080,
  "message": "New open port detected: 8080/tcp",
  "acknowledged": true,
  "assigned_to_user_id": null,
  "assigned_to_email": null,
  "resolution_status": "open",
  "created_at": "2026-01-27T10:30:00+00:00",
  "severity": "info",
  "host_id": 42,
  "hostname": "webserver-01",
  "user_comment": null
}
```

### Example

```bash
curl -X PUT "http://localhost:8000/api/alerts/1/acknowledge" \
  -H "Authorization: Bearer <token>"
```

---

## Unacknowledge Alert

Remove acknowledgment from a single alert.

```
PUT /api/alerts/{alert_id}/unacknowledge
```

**Authentication:** Admin required

### Path Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `alert_id` | integer | The alert ID |

### Response

Returns the updated alert object with `acknowledged: false` and recomputed severity.

### Example

```bash
curl -X PUT "http://localhost:8000/api/alerts/1/unacknowledge" \
  -H "Authorization: Bearer <token>"
```

---

## Bulk Acknowledge Alerts

Acknowledge multiple alerts in a single request.

```
PUT /api/alerts/acknowledge-bulk
```

**Authentication:** Admin required

### Request Body

JSON array of alert IDs to acknowledge.

```json
[1, 2, 3, 4, 5]
```

### Response

```json
{
  "acknowledged_ids": [1, 2, 3, 5],
  "missing_ids": [4]
}
```

| Field | Description |
|-------|-------------|
| `acknowledged_ids` | Alert IDs that were successfully acknowledged (sorted) |
| `missing_ids` | Alert IDs that were not found (sorted) |

### Example

```bash
curl -X PUT "http://localhost:8000/api/alerts/acknowledge-bulk" \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '[1, 2, 3, 4, 5]'
```

---

## Bulk Whitelist (Global)

Create global whitelist rules for multiple alerts, acknowledging them in the process.

```
POST /api/alerts/bulk-whitelist-global
```

**Authentication:** Admin required

### Request Body

```json
{
  "alert_ids": [1, 2, 3],
  "reason": "Approved web services"
}
```

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `alert_ids` | array[integer] | Yes | Alert IDs to whitelist |
| `reason` | string | Yes | Description for the whitelist rules |

### Response

```json
{
  "whitelisted_count": 3,
  "acknowledged_ids": [1, 2, 3],
  "missing_ids": [],
  "errors": []
}
```

| Field | Description |
|-------|-------------|
| `whitelisted_count` | Number of unique IP:port combinations whitelisted |
| `acknowledged_ids` | Alert IDs that were acknowledged |
| `missing_ids` | Alert IDs that were not found |
| `errors` | Any errors encountered during processing |

### Example

```bash
curl -X POST "http://localhost:8000/api/alerts/bulk-whitelist-global" \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"alert_ids": [1, 2, 3], "reason": "Approved monitoring services"}'
```

---

## Bulk Whitelist (Network)

Create network-specific whitelist rules for multiple alerts, acknowledging them in the process.

```
POST /api/alerts/bulk-whitelist-network
```

**Authentication:** Admin required

### Request Body

```json
{
  "alert_ids": [1, 2, 3],
  "reason": "Approved services for production network"
}
```

### Response

Same response format as bulk-whitelist-global.

### Behavior

- Groups alerts by their `network_id`
- Creates network-specific port rules for each unique IP:port combination per network
- Returns an error for any alert that has no associated network

### Example

```bash
curl -X POST "http://localhost:8000/api/alerts/bulk-whitelist-network" \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"alert_ids": [1, 2, 3], "reason": "Approved services for production"}'
```

---

## Create Comment

Add a comment to an alert.

```
POST /api/alerts/{alert_id}/comments
```

**Authentication:** Required (any authenticated user)

### Path Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `alert_id` | integer | The alert ID |

### Request Body

```json
{
  "comment": "Investigating this alert - appears to be a new service deployment"
}
```

| Field | Type | Required | Constraints |
|-------|------|----------|-------------|
| `comment` | string | Yes | 1-10000 characters |

### Response (201 Created)

```json
{
  "id": 1,
  "alert_id": 1,
  "user_id": 5,
  "user_email": "admin@example.com",
  "comment": "Investigating this alert - appears to be a new service deployment",
  "created_at": "2026-01-27T11:00:00+00:00",
  "updated_at": "2026-01-27T11:00:00+00:00"
}
```

### Example

```bash
curl -X POST "http://localhost:8000/api/alerts/1/comments" \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"comment": "Investigating this alert"}'
```

---

## List Comments

Get all comments for an alert.

```
GET /api/alerts/{alert_id}/comments
```

**Authentication:** Required (any authenticated user)

### Path Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `alert_id` | integer | The alert ID |

### Response

```json
{
  "comments": [
    {
      "id": 1,
      "alert_id": 1,
      "user_id": 5,
      "user_email": "admin@example.com",
      "comment": "Investigating this alert - appears to be a new service deployment",
      "created_at": "2026-01-27T11:00:00+00:00",
      "updated_at": "2026-01-27T11:00:00+00:00"
    },
    {
      "id": 2,
      "alert_id": 1,
      "user_id": 3,
      "user_email": "ops@example.com",
      "comment": "Confirmed - this is the new monitoring agent",
      "created_at": "2026-01-27T11:30:00+00:00",
      "updated_at": "2026-01-27T11:30:00+00:00"
    }
  ]
}
```

### Example

```bash
curl -X GET "http://localhost:8000/api/alerts/1/comments" \
  -H "Authorization: Bearer <token>"
```

---

## Update Comment

Update an existing comment.

```
PATCH /api/alerts/{alert_id}/comments/{comment_id}
```

**Authentication:** Required (comment author or admin)

### Path Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `alert_id` | integer | The alert ID |
| `comment_id` | integer | The comment ID |

### Request Body

```json
{
  "comment": "Updated comment text with additional findings"
}
```

### Response

Returns the updated comment object with modified `updated_at` timestamp.

### Authorization

- Comment authors can update their own comments
- Admins can update any comment

### Example

```bash
curl -X PATCH "http://localhost:8000/api/alerts/1/comments/1" \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"comment": "Updated: Service was approved by DevOps team"}'
```

---

## Delete Comment

Delete a comment from an alert.

```
DELETE /api/alerts/{alert_id}/comments/{comment_id}
```

**Authentication:** Required (comment author or admin)

### Path Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `alert_id` | integer | The alert ID |
| `comment_id` | integer | The comment ID |

### Response

204 No Content on success.

### Authorization

- Comment authors can delete their own comments
- Admins can delete any comment

### Example

```bash
curl -X DELETE "http://localhost:8000/api/alerts/1/comments/1" \
  -H "Authorization: Bearer <token>"
```

---

## Assign Alert

Assign or unassign an alert to a user.

```
PATCH /api/alerts/{alert_id}/assign
```

**Authentication:** Required (any authenticated user)

### Path Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `alert_id` | integer | The alert ID |

### Request Body

```json
{
  "user_id": 5
}
```

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `user_id` | integer or null | No | User ID to assign, or null to unassign |

### Response

Returns the updated alert object with `assigned_to_user_id` and `assigned_to_email` fields populated.

### Example

```bash
# Assign alert to user
curl -X PATCH "http://localhost:8000/api/alerts/1/assign" \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"user_id": 5}'

# Unassign alert
curl -X PATCH "http://localhost:8000/api/alerts/1/assign" \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"user_id": null}'
```

---

## Update Status

Update the resolution status of an alert.

```
PATCH /api/alerts/{alert_id}/status
```

**Authentication:** Required (any authenticated user)

### Path Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `alert_id` | integer | The alert ID |

### Request Body

```json
{
  "resolution_status": "in_progress"
}
```

| Field | Type | Required | Values |
|-------|------|----------|--------|
| `resolution_status` | string | Yes | `open`, `in_progress`, `resolved` |

### Response

Returns the updated alert object.

### Example

```bash
# Mark alert as being investigated
curl -X PATCH "http://localhost:8000/api/alerts/1/status" \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"resolution_status": "in_progress"}'

# Mark alert as resolved
curl -X PATCH "http://localhost:8000/api/alerts/1/status" \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{"resolution_status": "resolved"}'
```

---

## Export to CSV

Export alerts as a CSV file.

```
GET /api/alerts/export/csv
```

**Authentication:** Required (any authenticated user)

### Query Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `type` | string | No | Filter by alert type |
| `acknowledged` | boolean | No | Filter by acknowledgment status |

### Response

Returns a streaming CSV file download.

**Content-Type:** `text/csv`
**Content-Disposition:** `attachment; filename=alerts_YYYYMMDD_HHMMSS.csv`

### CSV Format

```csv
Alert Type,IP,Port,Network,Status,Created At
new_port,192.168.1.100,8080,Production,Open,2026-01-27T10:30:00+00:00
not_allowed,192.168.1.101,22,Production,In Progress,2026-01-27T09:15:00+00:00
blocked,10.0.0.50,3389,Office,Resolved,2026-01-26T14:00:00+00:00
```

### Example

```bash
# Export all alerts to CSV
curl -X GET "http://localhost:8000/api/alerts/export/csv" \
  -H "Authorization: Bearer <token>" \
  -o alerts.csv

# Export only unacknowledged blocked alerts
curl -X GET "http://localhost:8000/api/alerts/export/csv?type=blocked&acknowledged=false" \
  -H "Authorization: Bearer <token>" \
  -o blocked_alerts.csv
```

---

## Export to PDF

Export alerts as a PDF report.

```
GET /api/alerts/export/pdf
```

**Authentication:** Required (any authenticated user)

### Query Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `type` | string | No | Filter by alert type |
| `acknowledged` | boolean | No | Filter by acknowledgment status |

### Response

Returns a streaming PDF file download.

**Content-Type:** `application/pdf`
**Content-Disposition:** `attachment; filename=alerts_YYYYMMDD_HHMMSS.pdf`

### PDF Contents

The PDF report includes:
- Title: "Alerts Report"
- Generation timestamp
- Summary statistics:
  - Total alerts
  - Open alerts count
  - Acknowledged alerts count
  - Count by alert type
- Detailed table with columns:
  - Alert Type
  - IP
  - Port
  - Network
  - Status
  - Created At

### Example

```bash
# Export all alerts to PDF
curl -X GET "http://localhost:8000/api/alerts/export/pdf" \
  -H "Authorization: Bearer <token>" \
  -o alerts.pdf

# Export filtered alerts to PDF
curl -X GET "http://localhost:8000/api/alerts/export/pdf?acknowledged=false" \
  -H "Authorization: Bearer <token>" \
  -o unacknowledged_alerts.pdf
```

---

## Error Responses

All endpoints return standard error responses:

| Status Code | Description |
|-------------|-------------|
| 400 | Bad Request - Invalid parameters or empty alert_ids list |
| 401 | Unauthorized - Missing or invalid authentication |
| 403 | Forbidden - Insufficient permissions (e.g., viewer trying to acknowledge) |
| 404 | Not Found - Alert or comment not found |
| 500 | Internal Server Error |

### Error Format

```json
{
  "detail": "Alert not found"
}
```
